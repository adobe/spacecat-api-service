site-by-base-url:
  parameters:
    - $ref: './parameters.yaml#/base64BaseUrl'
  get:
    tags:
      - site
    summary: Retrieve a single site by its Base URL
    description: |
      This endpoint is useful for retrieving a site when you only have its Base URL. The Base URL is a unique identifier for a site other than the Site ID.
      The base URL provided in the path must be base64 encoded. This is to allow for URLs with special characters to be used as path parameters.
    operationId: getSiteByBaseUrl
    responses:
      '200':
        description: Successful operation with a site object returned
        content:
          application/json:
            schema:
              $ref: './schemas.yaml#/Site'
      '400':
        $ref: './responses.yaml#/400-no-base-url'
      '401':
        $ref: './responses.yaml#/401'
      '404':
        $ref: './responses.yaml#/404-site-not-found-with-base-url'
      '500':
        $ref: './responses.yaml#/500'
    security:
      - api_key: [ ]
site:
  parameters:
    - $ref: './parameters.yaml#/siteId'
  get:
    tags:
      - site
    summary: Retrieve a single site by its ID
    description: |
      This endpoint is useful for retrieving a site by its ID.
    operationId: getSite
    responses:
      '200':
        description: Successful operation with a site object returned
        content:
          application/json:
            schema:
              $ref: './schemas.yaml#/Site'
      '400':
        $ref: './responses.yaml#/400-no-site-id'
      '401':
        $ref: './responses.yaml#/401'
      '404':
        $ref: './responses.yaml#/404-site-not-found-with-id'
      '500':
        $ref: './responses.yaml#/500'
    security:
      - api_key: [ ]
  patch:
    tags:
      - site
    summary: Update a site
    description: |
      This endpoint is useful for updating a site.
      Only the fields as per the request body schema will be updated.
      At least one field to update must be provided in the request body.
    operationId: patchSite
    security:
      - admin_key: [ ]
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: './schemas.yaml#/SiteUpdate'
    responses:
      '200':
        description: Site updated successfully
        content:
          application/json:
            schema:
              $ref: './schemas.yaml#/Site'
      '400':
        $ref: './responses.yaml#/400-no-site-id-request-body-no-updates'
      '401':
        $ref: './responses.yaml#/401'
      '404':
        $ref: './responses.yaml#/404-site-not-found-with-id'
      '500':
        $ref: './responses.yaml#/500'
  delete:
    tags:
      - site
    summary: Delete a site
    description: |
      This endpoint is useful for deleting a site.
    operationId: deleteSite
    security:
      - admin_key: [ ]
    responses:
      '204':
        description: Site deleted successfully
      '400':
        $ref: './responses.yaml#/400-no-site-id'
      '401':
        $ref: './responses.yaml#/401'
      '404':
        $ref: './responses.yaml#/404-site-not-found-with-id'
      '500':
        $ref: './responses.yaml#/500'

site-cdn-logs-config:
  parameters:
    - $ref: './parameters.yaml#/siteId'
  patch:
    tags:
      - site
    summary: Update CDN logs configuration for a site
    description: |
      This endpoint allows updating the CDN logs configuration for a specific site.
    operationId: updateSiteCdnLogsConfig
    security:
      - ims_key: [ ]
      - scoped_api_key: [ ]
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: './schemas.yaml#/CdnLogsConfigUpdate'
    responses:
      '200':
        description: CDN logs configuration updated successfully
        content:
          application/json:
            schema:
              $ref: './schemas.yaml#/Site'
      '400':
        $ref: './responses.yaml#/400-no-site-id'
      '401':
        $ref: './responses.yaml#/401'
      '404':
        $ref: './responses.yaml#/404-site-not-found-with-id'
      '500':
        $ref: './responses.yaml#/500'

site-reports:
  parameters:
    - $ref: './parameters.yaml#/siteId'
  get:
    tags:
      - reports
    summary: Get all reports for a site
    description: |
      Retrieves all reports generated for the specified site, including their current status and download links.
      Reports can be in various states: processing, failed or success.
    operationId: getAllReportsBySiteId
    responses:
      '200':
        description: Successful operation with array of reports
        content:
          application/json:
            schema:
              type: object
              properties:
                siteId:
                  type: string
                  format: uuid
                  description: The site ID
                reports:
                  type: array
                  items:
                    $ref: './schemas.yaml#/Report'
                count:
                  type: integer
                  description: Total number of reports
              example:
                siteId: "550e8400-e29b-41d4-a716-446655440000"
                count: 2
                reports:
                  - id: "550e8400-e29b-41d4-a716-446655440001"
                    siteId: "550e8400-e29b-41d4-a716-446655440000"
                    reportType: "performance"
                    status: "success"
                    storagePath: "/reports/550e8400-e29b-41d4-a716-446655440000/performance/550e8400-e29b-41d4-a716-446655440001/"
                    reportPeriod:
                      startDate: "2024-01-01"
                      endDate: "2024-01-31"
                    comparisonPeriod:
                      startDate: "2023-12-01"
                      endDate: "2023-12-31"
                    createdAt: "2024-01-15T10:30:00Z"
                    updatedAt: "2024-01-15T11:45:00Z"
                    updatedBy: "user@example.com"
                    data:
                      rawPresignedUrl: "https://s3.amazonaws.com/bucket/reports/raw/report.json?signature=..."
                      rawPresignedUrlExpiresAt: "2024-01-22T10:30:00Z"
                      mystiquePresignedUrl: "https://s3.amazonaws.com/bucket/reports/mystique/report.json?signature=..."
                      mystiquePresignedUrlExpiresAt: "2024-01-22T10:30:00Z"
                  - id: "550e8400-e29b-41d4-a716-446655440002"
                    siteId: "550e8400-e29b-41d4-a716-446655440000"
                    reportType: "seo"
                    status: "processing"
                    storagePath: "/reports/550e8400-e29b-41d4-a716-446655440000/seo/550e8400-e29b-41d4-a716-446655440002/"
                    reportPeriod:
                      startDate: "2024-02-01"
                      endDate: "2024-02-28"
                    comparisonPeriod:
                      startDate: "2024-01-01"
                      endDate: "2024-01-31"
                    createdAt: "2024-02-15T10:30:00Z"
                    updatedAt: "2024-02-15T10:30:00Z"
                    updatedBy: "user@example.com"
      '400':
        description: Bad request - validation errors
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the validation failure
                  example: "Valid site ID is required"
      '401':
        $ref: './responses.yaml#/401'
      '403':
        description: Access denied - user does not have permission to access this resource
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '404':
        description: Site or report not found
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the server error
                  example: "Failed to get reports: [specific error message]"
    security:
      - ims_key: [ ]
      - scoped_api_key: [ ]
  post:
    tags:
      - reports
    summary: Create a new report generation job
    description: |
      Initiates the generation of a new report for the specified site and report type.
      The report will go through multiple phases: generation, AI enhancement via Mystique, and finalization.
    operationId: createReport
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - reportType
              - name
              - reportPeriod
              - comparisonPeriod
            properties:
              reportType:
                type: string
                enum: [optimization, performance]
                description: The type of report to generate
                example: 'performance'
              name:
                type: string
                description: The name of the report (required)
                example: 'Hersheyland'
              reportPeriod:
                type: object
                required:
                  - startDate
                  - endDate
                properties:
                  startDate:
                    type: string
                    pattern: '^\d{4}-\d{2}-\d{2}$'
                    description: Start date for the report period in YYYY-MM-DD format
                    example: "2024-01-01"
                  endDate:
                    type: string
                    pattern: '^\d{4}-\d{2}-\d{2}$'
                    description: End date for the report period in YYYY-MM-DD format
                    example: "2024-01-31"
              comparisonPeriod:
                type: object
                required:
                  - startDate
                  - endDate
                properties:
                  startDate:
                    type: string
                    pattern: '^\d{4}-\d{2}-\d{2}$'
                    description: Start date for comparison period in YYYY-MM-DD format
                    example: "2023-12-01"
                  endDate:
                    type: string
                    pattern: '^\d{4}-\d{2}-\d{2}$'
                    description: End date for comparison period in YYYY-MM-DD format
                    example: "2023-12-31"
            example:
              reportType: "performance"
              name: "Hersheyland"
              reportPeriod:
                startDate: "2024-01-01"
                endDate: "2024-01-31"
              comparisonPeriod:
                startDate: "2023-12-01"
                endDate: "2023-12-31"
    responses:
      '200':
        description: Report generation job queued successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Report generation job queued successfully"
                siteId:
                  type: string
                  format: uuid
                  description: The unique identifier of the site
                reportType:
                  type: string
                  description: The type of report requested
                  example: "performance"
                status:
                  type: string
                  enum: [processing]
                  description: Current status of the report job
                jobId:
                  type: string
                  format: uuid
                  description: Unique identifier for the report job
                timestamp:
                  type: string
                  format: date-time
                  description: Timestamp when the job was created
            example:
              message: "Report generation job queued successfully"
              siteId: "550e8400-e29b-41d4-a716-446655440000"
              reportType: "performance"
              status: "processing"
              jobId: "550e8400-e29b-41d4-a716-446655440001"
              timestamp: "2024-01-15T10:30:00Z"
      '400':
        description: Bad request - validation errors
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the validation failure
                  examples:
                    - "Valid site ID is required"
                    - "Request data is required"
                    - "Report name is required"
                    - "Report type is required"
                    - "Invalid report type. Valid types are: optimization, performance"
                    - "Report period is required"
                    - "Report period start date is required"
                    - "Report period end date is required"
                    - "Report period start date must be in YYYY-MM-DD format"
                    - "Report period end date must be in YYYY-MM-DD format"
                    - "Report period start date is not a valid date"
                    - "Report period end date is not a valid date"
                    - "Report period start date must be less than or equal to end date"
                    - "Comparison period is required"
                    - "Comparison period start date is required"
                    - "Comparison period end date is required"
                    - "Comparison period start date must be in YYYY-MM-DD format"
                    - "Comparison period end date must be in YYYY-MM-DD format"
                    - "Comparison period start date is not a valid date"
                    - "Comparison period end date is not a valid date"
                    - "Comparison period start date must be less than or equal to end date"
      '409':
        description: Conflict - duplicate report exists
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the conflict
                  example: "Report already exists for site 550e8400-e29b-41d4-a716-446655440000 with the same parameters"
                status:
                  type: string
                  description: Current status of the existing report
                  example: "success"
                reportId:
                  type: string
                  format: uuid
                  description: ID of the existing report
                  example: "550e8400-e29b-41d4-a716-446655440001"
      '401':
        $ref: './responses.yaml#/401'
      '403':
        description: Access denied - user does not have permission to access this resource
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '404':
        $ref: './responses.yaml#/404-site-not-found-with-id'
      '500':
        description: Internal server error - configuration or processing issues
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the server error
                  examples:
                    - "Reports queue is not configured"
                    - "Failed to create report job: SQS error"
                    - "Failed to create report job: [specific error message]"
    security:
      - ims_key: [ ]
      - scoped_api_key: [ ]

site-report:
  parameters:
    - $ref: './parameters.yaml#/siteId'
    - name: reportId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: The unique identifier of the report
  get:
    tags:
      - reports
    summary: Get a specific report
    description: |
      Retrieves detailed information about a specific report, including download links 
      for base and enhanced versions. Only returns reports with 'success' status.
      Reports that are still processing will return a 400 error.
    operationId: getReport
    responses:
      '200':
        description: Successful operation with report details and download links
        content:
          application/json:
            schema:
              $ref: './schemas.yaml#/Report'
            example:
              id: "550e8400-e29b-41d4-a716-446655440001"
              siteId: "550e8400-e29b-41d4-a716-446655440000"
              reportType: "performance"
              status: "success"
              storagePath: "/reports/550e8400-e29b-41d4-a716-446655440000/performance/550e8400-e29b-41d4-a716-446655440001/"
              reportPeriod:
                startDate: "2024-01-01"
                endDate: "2024-01-31"
              comparisonPeriod:
                startDate: "2023-12-01"
                endDate: "2023-12-31"
              createdAt: "2024-01-15T10:30:00Z"
              updatedAt: "2024-01-15T11:45:00Z"
              updatedBy: "user@example.com"
              data:
                rawPresignedUrl: "https://s3.amazonaws.com/bucket/reports/raw/report.json?signature=..."
                rawPresignedUrlExpiresAt: "2024-01-22T10:30:00Z"
                mystiquePresignedUrl: "https://s3.amazonaws.com/bucket/reports/mystique/report.json?signature=..."
                mystiquePresignedUrlExpiresAt: "2024-01-22T10:30:00Z"
      '400':
        description: Bad request - validation errors
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message
                  examples:
                    - "Valid site ID is required"
                    - "Valid report ID is required"
                    - "Report does not belong to the specified site"
      '409':
        description: Conflict - report is still processing
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message
                  example: "Report is still processing."
      '401':
        $ref: './responses.yaml#/401'
      '403':
        description: Access denied - user does not have permission to access this resource
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '404':
        description: Site or report not found
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the server error
                  example: "Failed to get report: [specific error message]"
    security:
      - ims_key: [ ]
      - scoped_api_key: [ ]
  patch:
    tags:
      - reports
    summary: Update enhanced report data
    description: |
      Updates the enhanced report data in S3 storage for a specific report.
      This endpoint only updates the enhanced report (Mystique analysis) and leaves the raw report unchanged.
      Only reports with 'success' status can be updated.
    operationId: patchReport
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - data
            properties:
              data:
                type: object
                description: The enhanced report data to update
                additionalProperties: true
            example:
              data:
                summary: "Updated performance analysis"
                insights: ["Improved Core Web Vitals", "Better SEO optimization"]
                recommendations: ["Optimize images", "Minimize CSS"]
    responses:
      '200':
        description: Enhanced report data updated successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Enhanced report updated successfully"
                siteId:
                  type: string
                  format: uuid
                reportId:
                  type: string
                  format: uuid
                updatedAt:
                  type: string
                  format: date-time
                  description: Timestamp when the report was updated
            example:
              message: "Enhanced report updated successfully"
              siteId: "550e8400-e29b-41d4-a716-446655440000"
              reportId: "550e8400-e29b-41d4-a716-446655440001"
              updatedAt: "2024-01-15T11:45:00Z"
      '400':
        description: Bad request - validation errors
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message
                  examples:
                    - "Valid site ID is required"
                    - "Valid report ID is required"
                    - "Request data is required"
                    - "Report does not belong to the specified site"
                    - "Can only update reports that are in success status"
                    - "Report does not have a valid storage path"
      '401':
        $ref: './responses.yaml#/401'
      '403':
        description: Access denied - user does not have permission to access this resource
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '404':
        description: Site or report not found
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the server error
                  examples:
                    - "Failed to update report in S3: [specific S3 error message]"
                    - "Failed to update report: [specific error message]"
    security:
      - ims_key: [ ]
      - scoped_api_key: [ ]
  delete:
    tags:
      - reports
    summary: Delete a specific report
    description: |
      Deletes a specific report from the database and removes its associated files from S3 storage.
      For successful reports, this includes both the raw report data and enhanced Mystique analysis files.
      This action cannot be undone.
    operationId: deleteReport
    responses:
      '200':
        description: Report deleted successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Report deleted successfully"
                siteId:
                  type: string
                  format: uuid
                reportId:
                  type: string
                  format: uuid
      '400':
        description: Bad request - validation errors
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the validation failure
                  examples:
                    - "Valid site ID is required"
                    - "Valid report ID is required"
                    - "Report does not belong to the specified site"
      '401':
        $ref: './responses.yaml#/401'
      '403':
        description: Access denied - user does not have permission to access this resource
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '404':
        description: Site or report not found
        headers:
          X-Error:
            $ref: './headers.yaml#/xError'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the server error
                  example: "Failed to delete report: [specific error message]"
    security:
      - ims_key: [ ]
      - scoped_api_key: [ ]

site-graph:
  parameters:
    - $ref: './parameters.yaml#/siteId'
  post:
    tags:
      - site
      - reports
    summary: Get optimization report graph data
    description: |
      Retrieves time-series graph data for optimization reports based on Real User Monitoring (RUM) metrics.
      This endpoint queries the RUM API to fetch performance metrics over a specified time range for one or more URLs.
      
      The data is aggregated according to the specified granularity (e.g., daily, weekly) and can be used to
      visualize performance trends and patterns for optimization reports.
      
      **Use Cases:**
      - Displaying performance trends over time in optimization reports
      - Comparing metrics across multiple pages
      - Analyzing performance changes within specific date ranges
    operationId: getSiteGraphData
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - urls
              - startDate
              - endDate
              - granularity
            properties:
              urls:
                type: array
                description: Array of URLs to retrieve graph data for
                minItems: 1
                items:
                  type: string
                  format: uri
                example: 
                  - "https://example.com/page1"
                  - "https://example.com/page2"
              startDate:
                type: string
                pattern: '^\d{4}-\d{2}-\d{2}$'
                description: Start date for the data range in YYYY-MM-DD format
                example: "2024-01-01"
              endDate:
                type: string
                pattern: '^\d{4}-\d{2}-\d{2}$'
                description: End date for the data range in YYYY-MM-DD format
                example: "2024-01-31"
              granularity:
                type: string
                description: Time granularity for data aggregation
                enum: [hour, day, week, month]
                example: "day"
          example:
            urls:
              - "https://example.com/page1"
              - "https://example.com/page2"
            startDate: "2024-01-01"
            endDate: "2024-01-31"
            granularity: "day"
    responses:
      '200':
        description: Successfully retrieved graph data from RUM API
        content:
          application/json:
            schema:
              type: object
              description: Graph data structure returned by the RUM API
              additionalProperties: true
              example:
                data:
                  - date: "2024-01-01"
                    value: 100
                    metrics:
                      lcp: 2.5
                      fid: 0.1
                      cls: 0.05
                  - date: "2024-01-02"
                    value: 150
                    metrics:
                      lcp: 2.3
                      fid: 0.08
                      cls: 0.04
      '400':
        description: Bad request - validation errors
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the validation failure
            examples:
              missingSiteId:
                summary: Site ID is required
                value:
                  message: "Site ID required"
              missingUrls:
                summary: URLs array is required
                value:
                  message: "urls array is required and must not be empty"
              emptyUrls:
                summary: URLs array is empty
                value:
                  message: "urls array is required and must not be empty"
              missingStartDate:
                summary: Start date is required
                value:
                  message: "startDate is required"
              missingEndDate:
                summary: End date is required
                value:
                  message: "endDate is required"
              missingGranularity:
                summary: Granularity is required
                value:
                  message: "granularity is required"
      '401':
        $ref: './responses.yaml#/401'
      '403':
        description: Access denied - user does not have permission to access this site
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Only users belonging to the organization can view graph data"
      '404':
        description: Site not found
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  example: "Site not found"
      '500':
        description: Internal server error - RUM API query failed
        content:
          application/json:
            schema:
              type: object
              properties:
                message:
                  type: string
                  description: Error message describing the server error
                  example: "Failed to retrieve graph data"
    security:
      - ims_key: [ ]
      - scoped_api_key: [ ]
