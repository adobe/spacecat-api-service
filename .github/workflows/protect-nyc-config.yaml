name: Protect NYC config

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
      - ".nycrc.json"

jobs:
  protect-nyc:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Show basic PR info
        run: |
          echo "PR number: ${{ github.event.number }}"
          echo "PR author: ${{ github.event.pull_request.user.login }}"
          echo "Draft: ${{ github.event.pull_request.draft }}"

      - name: Skip check for draft PRs
        if: github.event.pull_request.draft == true
        run: |
          echo "PR is in draft state; skipping protection check."

      - name: Check if author is in adobe/spacecat-admins
        if: github.event.pull_request.draft == false
        env:
          ORG: adobe
          TEAM_SLUG: spacecat-admins
          USERNAME: ${{ github.event.pull_request.user.login }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking if $USERNAME is in team $ORG/$TEAM_SLUG"
          STATUS_CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/orgs/${ORG}/teams/${TEAM_SLUG}/memberships/${USERNAME}")
          echo "API status code: $STATUS_CODE"
          if [ "$STATUS_CODE" -eq 200 ]; then
            echo "User $USERNAME is a member of $ORG/$TEAM_SLUG (allowed to modify .nycrc.json)."
          elif [ "$STATUS_CODE" -eq 404 ]; then
            echo "User $USERNAME is NOT a member of $ORG/$TEAM_SLUG."
            echo "Only members of $ORG/$TEAM_SLUG can modify .nycrc.json." >&2
            exit 1
          else
            echo "Unexpected response from GitHub API (status $STATUS_CODE)." >&2
            echo "Failing conservatively to avoid unauthorized changes." >&2
            exit 1
          fi

